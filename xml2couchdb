#!/bin/bash

function normalize_json_doc() {
	php -r '$j=json_decode(file_get_contents("php://stdin"));
	unset($j->_id);
	unset($j->_rev);
	if (isset($j->meta->ctime))
		unset($j->meta->ctime);
	print json_encode($j);'
}

while read type; do
	echo $type;
	while read file; do
		id=$type:$(xml sel -t -m "/$type" -v @id $file);
		id=${id/\//:};
		# echo $id;

		# id2=${file//\//:};
		# id2=${id2%%.xml}
		# if [ $id != $id2 ]; then
		# 	echo "path and id differ. $id != $id2";
		# fi

		couch_url="http://localhost:5984/beercrush/$id"

		./xml2json < $file | jsontidy > $id.json;

		if ! curl --silent --fail --write-out "%{http_code}" -X PUT --data-binary @- $couch_url < $id.json > curl.out; then
		
			http_code=$(cat curl.out);
			if (( $http_code != 409 )); then
				echo $id $http_code;
			else

				# Should we try to update it?
				if ! curl --silent --fail $couch_url | jsontidy > existing.json; then
					echo "Failed to get $couch_url";
				else

					# indb_md5=$(cat existing.json | normalize_json_doc | jsontidy | md5sum | awk '{print $1}');
					# this_md5=$(cat $id.json | normalize_json_doc | jsontidy | md5sum | awk '{print $1}');
					# 
					# if [[ $this_md5 != $indb_md5 ]]; then
					if jsondiff <(cat existing.json | normalize_json_doc | jsontidy) <(cat $id.json | normalize_json_doc | jsontidy); then
						# Yes, they're different
						# Get the _rev
						rev=$(cat existing.json | php -r '$obj=json_decode(file_get_contents("php://stdin"));print $obj->_rev."\n";');
						# echo "Updating $id ($rev)";
						# echo "Docs are diff: $this_md5 != $indb_md5";
						# jsondiff <(cat existing.json | normalize_json_doc | jsontidy) <(cat $id.json | normalize_json_doc | jsontidy) |colordiff;
						
						if ! cat $id.json | 
							php -r '$j=json_decode(file_get_contents("php://stdin"));$j->_rev=$argv[1];print json_encode($j);' $rev | 
							curl --silent --fail --write-out "%{http_code}" -X PUT --data-binary @- $couch_url > curl.out; then
							http_code=$(cat curl.out);
							echo "ERROR: unable to udpate $id: $http_code";
						else
							echo "Updated $id";
						fi
					fi
					
					rm -f existing.json;
				fi
			fi
		fi
		
		rm -f $id.json;
	
	done < <(find $type -name "*.xml");
	
done < <(find . -type d -maxdepth 1 ! -name ".*" | sed -e 's/^.\///');

rm -f curl.out
